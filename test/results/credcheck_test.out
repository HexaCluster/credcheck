LOAD 'credcheck';
ALTER SYSTEM SET credcheck.username_min_length TO DEFAULT;
ALTER SYSTEM SET credcheck.username_min_special TO DEFAULT;
ALTER SYSTEM SET credcheck.username_min_upper TO DEFAULT;
ALTER SYSTEM SET credcheck.username_min_upper TO DEFAULT;
ALTER SYSTEM SET credcheck.username_min_digit TO DEFAULT;
ALTER SYSTEM SET credcheck.username_contain_password TO DEFAULT;
ALTER SYSTEM SET credcheck.username_ignore_case TO DEFAULT;
ALTER SYSTEM SET credcheck.username_contain TO DEFAULT;
ALTER SYSTEM SET credcheck.username_not_contain TO DEFAULT;
ALTER SYSTEM SET credcheck.username_min_repeat TO DEFAULT;
ALTER SYSTEM SET credcheck.password_min_length TO DEFAULT;
ALTER SYSTEM SET credcheck.password_min_special TO DEFAULT;
ALTER SYSTEM SET credcheck.password_min_upper TO DEFAULT;
ALTER SYSTEM SET credcheck.password_min_upper TO DEFAULT;
ALTER SYSTEM SET credcheck.password_min_digit TO DEFAULT;
ALTER SYSTEM SET credcheck.password_contain_username TO DEFAULT;
ALTER SYSTEM SET credcheck.password_ignore_case TO DEFAULT;
ALTER SYSTEM SET credcheck.password_contain TO DEFAULT;
ALTER SYSTEM SET credcheck.password_not_contain TO DEFAULT;
ALTER SYSTEM SET credcheck.password_min_repeat TO DEFAULT;
--XXX
--to avoid the race condition among the reload_conf and next ALTER SYSTEM
--for now, we are adding some pg_sleep and hoping that
--postgresql SIGHUP will complete in the next 100ms
SELECT pg_reload_conf(), pg_sleep_for('100 milliseconds'::interval);
 pg_reload_conf | pg_sleep_for 
----------------+--------------
 t              | 
(1 row)

--username checks
--
--length must be >=2
--
ALTER SYSTEM SET credcheck.username_min_length TO 2;
SELECT pg_reload_conf(), pg_sleep_for('100 milliseconds'::interval);
 pg_reload_conf | pg_sleep_for 
----------------+--------------
 t              | 
(1 row)

DROP USER IF EXISTS aa;
NOTICE:  role "aa" does not exist, skipping
CREATE USER aa WITH PASSWORD 'dummy';
DROP USER IF EXISTS aa;
--
--min user repeat
--
ALTER SYSTEM SET credcheck.username_min_repeat TO 5;
SELECT pg_reload_conf(), pg_sleep_for('100 milliseconds'::interval);
 pg_reload_conf | pg_sleep_for 
----------------+--------------
 t              | 
(1 row)

DROP USER IF EXISTS abbbaaaaaa;
NOTICE:  role "abbbaaaaaa" does not exist, skipping
CREATE USER abbbaaaaaa WITH PASSWORD 'dummy';
ERROR:  username characters are repeated more than the configured credcheck.username_min_repeat times
DROP USER IF EXISTS abbbaaaaaa;
NOTICE:  role "abbbaaaaaa" does not exist, skipping
--
--min special >= 1
--
ALTER SYSTEM SET credcheck.username_min_special TO 1;
SELECT pg_reload_conf(), pg_sleep_for('100 milliseconds'::interval);
 pg_reload_conf | pg_sleep_for 
----------------+--------------
 t              | 
(1 row)

DROP USER IF EXISTS a$;
NOTICE:  role "a$" does not exist, skipping
CREATE USER a$ WITH PASSWORD 'dummy';
DROP USER IF EXISTS a$;
--
--min upper >=1
--
ALTER SYSTEM SET credcheck.username_min_upper TO 1;
SELECT pg_reload_conf(), pg_sleep_for('100 milliseconds'::interval);
 pg_reload_conf | pg_sleep_for 
----------------+--------------
 t              | 
(1 row)

DROP USER IF EXISTS "aA$";
NOTICE:  role "aA$" does not exist, skipping
CREATE USER "aA$" WITH PASSWORD 'dummy';
DROP USER IF EXISTS "aA$";
--
--min lower >=2
--
ALTER SYSTEM SET credcheck.username_min_lower TO 1;
SELECT pg_reload_conf(), pg_sleep_for('100 milliseconds'::interval);
 pg_reload_conf | pg_sleep_for 
----------------+--------------
 t              | 
(1 row)

DROP USER IF EXISTS "aaA$";
NOTICE:  role "aaA$" does not exist, skipping
CREATE USER "aaA$" WITH PASSWORD 'dummy';
DROP USER IF EXISTS "aaA$";
--
--must contain one of the characters 'a','b','c'
--
ALTER SYSTEM SET credcheck.username_contain TO 'a,b,c';
SELECT pg_reload_conf(), pg_sleep_for('100 milliseconds'::interval);
 pg_reload_conf | pg_sleep_for 
----------------+--------------
 t              | 
(1 row)

DROP USER IF EXISTS "aA$user";
CREATE USER "aA$user" WITH PASSWORD 'dummy';
DROP USER IF EXISTS auser;
NOTICE:  role "auser" does not exist, skipping
--
--must not contain one of the characters 'x','z'
--
ALTER SYSTEM SET credcheck.username_not_contain TO 'x,z';
SELECT pg_reload_conf(), pg_sleep_for('100 milliseconds'::interval);
 pg_reload_conf | pg_sleep_for 
----------------+--------------
 t              | 
(1 row)

DROP USER IF EXISTS "aaA$user";
NOTICE:  role "aaA$user" does not exist, skipping
CREATE USER "aaA$user" WITH PASSWORD 'dummy';
DROP USER IF EXISTS "aaA$user";
--
--username contain password
--
ALTER SYSTEM SET credcheck.username_contain_password TO on;
SELECT pg_reload_conf(), pg_sleep_for('100 milliseconds'::interval);
 pg_reload_conf | pg_sleep_for 
----------------+--------------
 t              | 
(1 row)

DROP USER IF EXISTS "aaA$usernopass";
NOTICE:  role "aaA$usernopass" does not exist, skipping
CREATE USER "aaA$usernopass" WITH PASSWORD 'dummy';
DROP USER IF EXISTS "aaA$usernopass";
--
--ignore case while performing checks
--
ALTER SYSTEM SET credcheck.username_ignore_case TO on;
SELECT pg_reload_conf(), pg_sleep_for('100 milliseconds'::interval);
 pg_reload_conf | pg_sleep_for 
----------------+--------------
 t              | 
(1 row)

DROP USER IF EXISTS "aa$user_dummy";
NOTICE:  role "aa$user_dummy" does not exist, skipping
CREATE USER "aa$user_dummy" WITH PASSWORD 'DUMMY';
ERROR:  username should not contain password
DROP USER IF EXISTS "aa$user_dummy";
NOTICE:  role "aa$user_dummy" does not exist, skipping
--
--min digit >=1
--
ALTER SYSTEM SET credcheck.username_min_digit TO 1;
SELECT pg_reload_conf(), pg_sleep_for('100 milliseconds'::interval);
 pg_reload_conf | pg_sleep_for 
----------------+--------------
 t              | 
(1 row)

DROP USER IF EXISTS aa;
NOTICE:  role "aa" does not exist, skipping
CREATE USER aa WITH PASSWORD 'dummy';
ERROR:  username does not contain the configured credcheck.username_min_digit characters
DROP USER IF EXISTS aa;
NOTICE:  role "aa" does not exist, skipping
--
--reset all settings
--
ALTER SYSTEM SET credcheck.username_min_length TO DEFAULT;
ALTER SYSTEM SET credcheck.username_min_special TO DEFAULT;
ALTER SYSTEM SET credcheck.username_min_upper TO DEFAULT;
ALTER SYSTEM SET credcheck.username_min_upper TO DEFAULT;
ALTER SYSTEM SET credcheck.username_min_digit TO DEFAULT;
ALTER SYSTEM SET credcheck.username_contain_password TO DEFAULT;
ALTER SYSTEM SET credcheck.username_ignore_case TO DEFAULT;
ALTER SYSTEM SET credcheck.username_contain TO DEFAULT;
ALTER SYSTEM SET credcheck.username_not_contain TO DEFAULT;
ALTER SYSTEM SET credcheck.username_min_repeat TO DEFAULT;
ALTER SYSTEM SET credcheck.password_min_length TO DEFAULT;
ALTER SYSTEM SET credcheck.password_min_special TO DEFAULT;
ALTER SYSTEM SET credcheck.password_min_upper TO DEFAULT;
ALTER SYSTEM SET credcheck.password_min_upper TO DEFAULT;
ALTER SYSTEM SET credcheck.password_min_digit TO DEFAULT;
ALTER SYSTEM SET credcheck.password_contain_username TO DEFAULT;
ALTER SYSTEM SET credcheck.password_ignore_case TO DEFAULT;
ALTER SYSTEM SET credcheck.password_contain TO DEFAULT;
ALTER SYSTEM SET credcheck.password_not_contain TO DEFAULT;
ALTER SYSTEM SET credcheck.password_min_repeat TO DEFAULT;
SELECT pg_reload_conf(), pg_sleep_for('100 milliseconds'::interval);
 pg_reload_conf | pg_sleep_for 
----------------+--------------
 t              | 
(1 row)

--password checks
--
--length must be >=2
--
ALTER SYSTEM SET credcheck.password_min_length TO 2;
SELECT pg_reload_conf(), pg_sleep_for('100 milliseconds'::interval);
 pg_reload_conf | pg_sleep_for 
----------------+--------------
 t              | 
(1 row)

DROP USER IF EXISTS aa;
NOTICE:  role "aa" does not exist, skipping
CREATE USER aa WITH PASSWORD 'd';
ERROR:  password length should match the configured credcheck.password_min_length
DROP USER IF EXISTS aa;
NOTICE:  role "aa" does not exist, skipping
--
--min special >= 1
--
ALTER SYSTEM SET credcheck.password_min_special TO 1;
SELECT pg_reload_conf(), pg_sleep_for('100 milliseconds'::interval);
 pg_reload_conf | pg_sleep_for 
----------------+--------------
 t              | 
(1 row)

DROP USER IF EXISTS aa;
NOTICE:  role "aa" does not exist, skipping
CREATE USER aa WITH PASSWORD 'a$';
DROP USER IF EXISTS aa;
--
--min upper >=1
--
ALTER SYSTEM SET credcheck.password_min_upper TO 1;
SELECT pg_reload_conf(), pg_sleep_for('100 milliseconds'::interval);
 pg_reload_conf | pg_sleep_for 
----------------+--------------
 t              | 
(1 row)

DROP USER IF EXISTS "aa";
NOTICE:  role "aa" does not exist, skipping
CREATE USER "aa" WITH PASSWORD 'aA$';
DROP USER IF EXISTS "aa";
--
--min lower >=2
--
ALTER SYSTEM SET credcheck.password_min_lower TO 1;
SELECT pg_reload_conf(), pg_sleep_for('100 milliseconds'::interval);
 pg_reload_conf | pg_sleep_for 
----------------+--------------
 t              | 
(1 row)

DROP USER IF EXISTS "aa";
NOTICE:  role "aa" does not exist, skipping
CREATE USER "aa" WITH PASSWORD 'aA$';
DROP USER IF EXISTS "aa";
--
--must contain one of the characters 'a','b','c'
--
ALTER SYSTEM SET credcheck.password_contain TO 'a,b,c';
SELECT pg_reload_conf(), pg_sleep_for('100 milliseconds'::interval);
 pg_reload_conf | pg_sleep_for 
----------------+--------------
 t              | 
(1 row)

DROP USER IF EXISTS "aa";
NOTICE:  role "aa" does not exist, skipping
CREATE USER "aa" WITH PASSWORD 'ddaU$';
DROP USER IF EXISTS "aa";
--
--must not contain one of the characters 'x','z'
--
ALTER SYSTEM SET credcheck.password_not_contain TO 'x,z';
SELECT pg_reload_conf(), pg_sleep_for('100 milliseconds'::interval);
 pg_reload_conf | pg_sleep_for 
----------------+--------------
 t              | 
(1 row)

DROP USER IF EXISTS "aa";
NOTICE:  role "aa" does not exist, skipping
CREATE USER "aa" WITH PASSWORD 'Ax$';
ERROR:  password does not contain the configured credcheck.password_contain characters
DROP USER IF EXISTS "aa";
NOTICE:  role "aa" does not exist, skipping
--
--username contain password
--
ALTER SYSTEM SET credcheck.password_contain_username TO on;
SELECT pg_reload_conf(), pg_sleep_for('100 milliseconds'::interval);
 pg_reload_conf | pg_sleep_for 
----------------+--------------
 t              | 
(1 row)

DROP USER IF EXISTS "aa";
NOTICE:  role "aa" does not exist, skipping
CREATE USER "aa" WITH PASSWORD 'Ab$';
DROP USER IF EXISTS "aa";
--
--ignore case while performing checks
--
ALTER SYSTEM SET credcheck.password_ignore_case TO on;
SELECT pg_reload_conf(), pg_sleep_for('100 milliseconds'::interval);
 pg_reload_conf | pg_sleep_for 
----------------+--------------
 t              | 
(1 row)

DROP USER IF EXISTS "aa";
NOTICE:  role "aa" does not exist, skipping
CREATE USER "aa" WITH PASSWORD 'random_AA$';
ERROR:  password should not contain username
DROP USER IF EXISTS "aa";
NOTICE:  role "aa" does not exist, skipping
--
--min digit >=1
--
ALTER SYSTEM SET credcheck.password_min_digit TO 1;
SELECT pg_reload_conf(), pg_sleep_for('100 milliseconds'::interval);
 pg_reload_conf | pg_sleep_for 
----------------+--------------
 t              | 
(1 row)

DROP USER IF EXISTS aa;
NOTICE:  role "aa" does not exist, skipping
CREATE USER aa WITH PASSWORD 'a@1';
DROP USER IF EXISTS aa;
--
--min password repeat 2
--
ALTER SYSTEM SET credcheck.password_min_repeat TO 2;
SELECT pg_reload_conf(), pg_sleep_for('100 milliseconds'::interval);
 pg_reload_conf | pg_sleep_for 
----------------+--------------
 t              | 
(1 row)

DROP USER IF EXISTS aa;
NOTICE:  role "aa" does not exist, skipping
CREATE USER aa WITH PASSWORD 'a@bbb';
ERROR:  password does not contain the configured credcheck.password_min_digit characters
DROP USER IF EXISTS aa;
NOTICE:  role "aa" does not exist, skipping
--
--reset all settings
--
ALTER SYSTEM SET credcheck.username_min_length TO DEFAULT;
ALTER SYSTEM SET credcheck.username_min_special TO DEFAULT;
ALTER SYSTEM SET credcheck.username_min_upper TO DEFAULT;
ALTER SYSTEM SET credcheck.username_min_upper TO DEFAULT;
ALTER SYSTEM SET credcheck.username_min_digit TO DEFAULT;
ALTER SYSTEM SET credcheck.username_contain_password TO DEFAULT;
ALTER SYSTEM SET credcheck.username_ignore_case TO DEFAULT;
ALTER SYSTEM SET credcheck.username_contain TO DEFAULT;
ALTER SYSTEM SET credcheck.username_not_contain TO DEFAULT;
ALTER SYSTEM SET credcheck.username_min_repeat TO DEFAULT;
ALTER SYSTEM SET credcheck.password_min_length TO DEFAULT;
ALTER SYSTEM SET credcheck.password_min_special TO DEFAULT;
ALTER SYSTEM SET credcheck.password_min_upper TO DEFAULT;
ALTER SYSTEM SET credcheck.password_min_upper TO DEFAULT;
ALTER SYSTEM SET credcheck.password_min_digit TO DEFAULT;
ALTER SYSTEM SET credcheck.password_contain_username TO DEFAULT;
ALTER SYSTEM SET credcheck.password_ignore_case TO DEFAULT;
ALTER SYSTEM SET credcheck.password_contain TO DEFAULT;
ALTER SYSTEM SET credcheck.password_not_contain TO DEFAULT;
ALTER SYSTEM SET credcheck.password_min_repeat TO DEFAULT;
